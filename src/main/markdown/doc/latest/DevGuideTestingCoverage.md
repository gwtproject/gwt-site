Testing Coverage
===

For measuring code coverage, GWT supports [EMMA](http://emma.sourceforge.net/), a widely used code coverage tool for Java code. To be able to interact with other EMMA tools, GWT uses EMMA in offline mode &mdash; that is, GWT uses classes instrumented by EMMA over the classes it obtains by compiling the Java source files.

We offer two ways of measuring code coverage: (i) using the EclEmma plugin in Eclipse and (ii) using command-line tools. For both techniques, use the [EMMA jar from GWT's download page](http://google-web-toolkit.googlecode.com/files/emma-2.0.5312-patched.jar) &mdash; it includes a patch so that EMMA does not throw away the coverage data if the same class is loaded by different classloaders, as is common in GWT.

1.  [Example](#example)
2.  [Using EclEmma, the Eclipse plugin for EMMA](#eclemma)
3.  [Using command-line tools](#command-line)

## Example<a id="example"></a>

As a running example, let us say we create a project with the provided `webAppCreator` and `junitCreator` tools as:

```shell
./webAppCreator -out myapp  
                     -junit ../../../../gwt-tools/lib/junit/junit-3.8.1.jar 
                     com.example.myapp.MyApp
```

Add the following `computeFactorial()` method to MyApp.java and the dummy `testFactorial()` method to MyAppTest.java

```java
int computeFactorial(int number) {
  if (number &le; 1) {
    return 1;
  }
  return number * computeFactorial(number - 1);
}
```

```java
public void testFactorial() {
}
```

This example is used in the following sections.

## Using EclEmma, the Eclipse plugin for EMMA<a id="eclemma"></a>

### Step 1: Install patched version of EclEmma &mdash; the Eclipse plugin<a id="install"></a>

1.  Follow instructions at [http://www.eclemma.org/installation.html](http://www.eclemma.org/installation.html) to install EclEmma.

Confirm that there is a "Coverage" block  in the **Run** menu. 

### Step 2: Create a "Run configuration" for running the tests in development mode<a id="configuration"></a>

Follow instructions for [running tests in Eclipse](DevGuideTesting.html#DevGuideRunningTestsInEclipse)

### Step 3: Get initial coverage data<a id="initial"></a>

To get coverage data, select the configuration from the Coverage tab and click "coverage."  In the screenshot below of the Eclipse window, you can see that the `src` folder has zero coverage (0 covered instructions of 195 instructions) whereas the test folder has 100% coverage (9 covered instructions). When you run it, your numbers might be different because we keep updating the starter application generated by webAppCreator. Note that these instructions are bytecode instructions; EclEmma maps them back to Java source code wherever possible. EclEmma highlights lines with colors:

*   covered lines = green
*   partially covered lines = yellow
*   lines with no coverage = red

This result is expected because, by default, the MyAppTest.java file does not exercise any of the application code. It has a simple test that returns true.

![img](images/TestCoverageInitial.jpg "Initial test coverage")

### Step 4: Improving coverage<a id="improving"></a>

Augment the MyAppTest.java by creating the testFactorial method:

```java
public void testFactorial() {
  assertEquals(1, new MyApp().computeFactorial(0));
}
```

On running coverage, now we see that out of 13 instructions in the method `computeFactorial` (the figure below shows the total instructions in the `computeFactorial` method), 5 instructions are covered. (Note that these instructions are bytecode instructions.) Let us add another statement to testFactorial() for testing the factorial computation for numbers greater than `0` such that the method becomes:

```java
public void testFactorial() {
  assertEquals(1, new MyApp().computeFactorial(0));
  assertEquals(2, new MyApp().computeFactorial(2));
}
```
 
On running coverage, now we see that coverage for the `computeFactorial()` method is indeed 100% as expected. The following screenshot of the Eclipse window shows the final coverage information. You can drill down on the individual class and methods to find the coverage information at the desired granularity. You can also export the coverage data to html or xml formats to keep track of your code coverage over time.

![img](images/TestCoverageFinal.jpg "Final test coverage")

## Using command-line tools<a id="command-line"></a>

Since GWT requires a patched version of EMMA, use the [EMMA jar from GWT's download page](http://google-web-toolkit.googlecode.com/files/emma-2.0.5312-patched.jar). Getting coverage results requires these steps:

1.  Step i - Generate the class files
2.  Step ii - Instrument the class files using Emma &mdash; this produces a coverage.em file
3.  Step iii - Run the test code after putting the modified emma.jar in the classpath

(For convenience, we copied the patched EMMA jar as emma.jar in the current directory.)

Step i: generate the class files

```shell
ant devmode
````

Step ii: use emma to instrument the class files, creates a coverage.em file

```shell
java -cp emma.jar emma instr -m overwrite -cp war/WEB-INF/classes/com/example/myapp/client
```

Expected output:

```text
EMMA: instrumentation path processed in 231 ms
EMMA: [5 class(es) instrumented, 0 resource(s) copied]
EMMA: metadata merged into [PARENT_DIR/samples/com/example/myapp/coverage.em] {in 17 ms}</span>
```

step iii: run the test code after putting the modified emma.jar in the classpath; generates a coverage.ec file

```shell
ant test.dev
```

Expected output

```text
EMMA: collecting runtime coverage data ...
..
Time: 12.968
OK (2 tests)
EMMA: runtime coverage data merged into [PARENT_DIR/samples/com/example/myapp/coverage.ec] {in 22 ms}</span>
```

Step iv: generate the coverage report HTML file

```shell
java -cp emma.jar emma report -r html -in coverage.em,coverage.ec </strong>
```

Expected output:

```text
EMMA: processing input files ...
EMMA: 2 file(s) read and merged in 13 ms
EMMA: writing [html] report to [PARENT_DIR/samples/com/example/myapp/coverage/index.html] ...</span>
```

Follow [Step 4](#improving) of the EclEmma section to improve coverage. As you add more tests, you can see your coverage increasing.
